{% extends 'base.html' %}

{% block title %}{{ challenge.title }} - CLINIX{% endblock %}

{% block content %}
<div class="container mx-auto py-8 px-4 lg:px-8">
  <!-- Header Section -->
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-8">
    <div>
      <div class="flex items-center gap-2 mb-3">
        <a href="{% url 'core:challenges' %}" class="text-neutral-600 hover:text-neutral-900 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m12 19-7-7 7-7"></path>
            <path d="M19 12H5"></path>
          </svg>
        </a>
        <span class="text-sm text-neutral-500">Retour aux défis</span>
      </div>
      <h1 class="text-4xl font-bold tracking-tight text-neutral-900 mb-3">
        {{ challenge.title }}
      </h1>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-semibold bg-primary-100 text-primary-700 border border-primary-200">
          {{ challenge.type }}
        </span>
        <span class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-semibold bg-primary-100 text-primary-700 border border-primary-200">
          {{ challenge.phase.title }}
        </span>
        <span class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-semibold bg-neutral-100 text-neutral-700 border border-neutral-200">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1.5">
            <circle cx="12" cy="8" r="6"></circle>
            <path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"></path>
          </svg>
          {{ challenge.points }} pts
        </span>
        <span class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium text-neutral-600">
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1.5">
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          {{ challenge.author }}
        </span>
      </div>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
    <div class="border-b border-neutral-200">
      <div class="flex">
        <button 
          id="tab-case" 
          class="px-6 py-4 text-sm font-semibold text-primary-600 border-b-2 border-primary-600 transition-colors" 
          onclick="showTab('case')">
          Description du cas
        </button>
        <button 
          id="tab-hints" 
          class="px-6 py-4 text-sm font-semibold text-neutral-600 hover:text-neutral-900 transition-colors" 
          onclick="showTab('hints')">
          Indices
        </button>
        <button 
          id="tab-submission" 
          class="px-6 py-4 text-sm font-semibold text-neutral-600 hover:text-neutral-900 transition-colors" 
          onclick="showTab('submission')">
          Soumission
        </button>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="p-8">
      <!-- Case Description Tab -->
      <div id="content-case">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-neutral-900 mb-2">Détails du cas</h2>
          <p class="text-neutral-600">Lisez attentivement le cas et analysez les symptômes</p>
        </div>
        <div class="prose prose-neutral max-w-none">
          {{ challenge.description | safe }}
        </div>
      </div>

      <!-- Hints Tab -->
      <div id="content-hints" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-neutral-900 mb-2">Indices Disponibles</h2>
          <p class="text-neutral-600">Demandez des images médicales pour vous aider dans votre diagnostic</p>
        </div>
        
        {% if hints %}
          <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {% for hint in hints %}
              <div class="bg-neutral-50 rounded-xl border-2 border-dashed border-neutral-300 p-6 hover:border-primary-300 hover:bg-primary-50/30 transition-all">
                <div class="mb-4">
                  <h3 class="text-lg font-bold text-neutral-900 mb-1">{{ hint.title }}</h3>
                  <p class="text-sm text-neutral-600">Coût : {{ hint.value }} points</p>
                </div>
                <button 
                  class="w-full inline-flex items-center justify-center rounded-lg text-sm font-semibold transition-all h-10 px-4 bg-neutral-900 text-white hover:bg-neutral-800 active:scale-95"
                  onclick="showHint('{{ hint.id }}', '{{ hint.title }}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  Voir {{ hint.title }}
                </button>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-12">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-neutral-100 mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-neutral-400">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-neutral-900 mb-1">Aucun indice disponible</h3>
            <p class="text-neutral-600">Aucun indice n'est disponible pour ce cas.</p>
          </div>
        {% endif %}
      </div>

      <!-- Submission Tab -->
      <div id="content-submission" class="hidden">
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-neutral-900 mb-2">Soumettez Votre Diagnostic</h2>
          <p class="text-neutral-600">
            Fournissez votre diagnostic et votre plan de traitement basé sur les informations du cas et les indices que vous avez demandés
          </p>
        </div>

        {% if not is_submitted %}
          <div id="submission-form">
            <form class="space-y-6" method="POST">
              {% csrf_token %}
              <div class="space-y-3">
                <label for="diagnosis" class="block text-sm font-semibold text-neutral-900">
                  Votre Diagnostic
                </label>
                <textarea 
                  id="diagnosis" 
                  name="diagnosis" 
                  rows="6"
                  placeholder="Entrez votre diagnostic ici..." 
                  class="w-full rounded-lg border border-neutral-300 bg-white px-4 py-3 text-sm text-neutral-900 placeholder:text-neutral-400 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/20 transition-all" 
                  required></textarea>
              </div>

              <button 
                type="submit" 
                class="w-full inline-flex items-center justify-center rounded-lg text-base font-semibold transition-all h-12 px-6 bg-primary-600 text-white hover:bg-primary-700 active:scale-95 shadow-lg shadow-primary-600/30">
                Soumettre la Solution
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2">
                  <path d="M5 12h14"></path>
                  <path d="m12 5 7 7-7 7"></path>
                </svg>
              </button>
            </form>
          </div>
        {% else %}
          <div id="submission-result" class="space-y-6">
            <div class="rounded-2xl bg-primary-50 border-2 border-primary-200 p-8">
              <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                  <div class="w-12 h-12 rounded-full bg-primary-600 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </div>
                </div>
                <div class="flex-1">
                  <h3 class="font-bold text-xl text-primary-900 mb-2">Diagnostic Soumis !</h3>
                  <p class="text-primary-800 mb-4">
                    Votre diagnostic a été soumis avec succès. Vous recevrez des retours sous peu.
                  </p>
                  <div class="pt-4 border-t border-primary-200">
                    <p class="font-semibold text-primary-900">Points à Gagner : {{ challenge.points }} points</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Hint Modal -->
<div id="hint-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
    <div class="p-6 border-b border-neutral-200">
      <div class="flex items-center justify-between">
        <div>
          <h3 id="hint-title" class="text-2xl font-bold text-neutral-900"></h3>
          <p class="text-sm text-neutral-600 mt-1">Analysez ces résultats attentivement pour vous aider dans votre diagnostic</p>
        </div>
        <button 
          onclick="closeHintModal()" 
          class="rounded-full p-2 hover:bg-neutral-100 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]" id="hint-body">
      {% for hint in hints %}
        <div id="hint-{{ hint.title }}" class="hidden">
          {% if hint.image %}
            <img src="{{ hint.image.url }}" alt="{{ hint.title }} Résultats" class="w-full rounded-lg">
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Tab functionality
  function showTab(tabName) {
    // Hide all content
    document.getElementById('content-case').classList.add('hidden');
    document.getElementById('content-hints').classList.add('hidden');
    document.getElementById('content-submission').classList.add('hidden');
    
    // Remove active styles from all tabs
    const tabs = ['tab-case', 'tab-hints', 'tab-submission'];
    tabs.forEach(tab => {
      const el = document.getElementById(tab);
      el.classList.remove('text-primary-600', 'border-b-2', 'border-primary-600');
      el.classList.add('text-neutral-600');
    });
    
    // Show selected content and activate tab
    document.getElementById('content-' + tabName).classList.remove('hidden');
    const activeTab = document.getElementById('tab-' + tabName);
    activeTab.classList.remove('text-neutral-600');
    activeTab.classList.add('text-primary-600', 'border-b-2', 'border-primary-600');
  }
  
  // Hint modal functionality
  const usedHints = {};

  function showHint(hintId, hintTitle) {
    if (usedHints[hintId]) {
      displayHintModal(hintTitle, usedHints[hintId]);
      return;
    }

    fetch(`/use-hint/${hintId}/`)
      .then(res => {
        if (!res.ok) throw new Error("Pas assez de points");
        return res.json();
      })
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }

        const hintContent = data.hint_html;
        usedHints[hintId] = hintContent;
        displayHintModal(hintTitle, hintContent);
      })
      .catch(err => {
        alert(err.message);
      });
  }

  function displayHintModal(hintTitle, content) {
    const modal = document.getElementById('hint-modal');
    const titleEl = document.getElementById('hint-title');
    const body = document.getElementById('hint-body');

    titleEl.textContent = `${hintTitle} Résultats`;
    body.innerHTML = content;
    modal.classList.remove('hidden');
  }
  
  function closeHintModal() {
    document.getElementById('hint-modal').classList.add('hidden');
  }

  // Close modal on outside click
  document.getElementById('hint-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeHintModal();
    }
  });
</script>
{% endblock %}